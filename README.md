[**学内アカウント管理システム**](https://campus.ogw3.com/)

# 概要

組織内の一時的なGoogleアカウント（ゲストアカウント）を管理するシステムです。正職員がゲストアカウントを発行・管理でき、ゲストユーザー自身が利用期限の延長申請を行うことができます。

## 背景

人事情報に登録されない職員（派遣、アルバイトなど）のゲストアカウントを効率的に管理するために開発されました。

**現状のフロー:**
- 発行: 正職員は自分の責任下で、ゲストアカウントを発行できる。
    1. 正職員がGoogleフォームでアカウントの利用申請
    2. 管理者側でアカウント発行
- 管理: 年に一度、アカウントが利用されているか確認する必要がある。
    1. 承認者（作成者）毎にスプレッドシートでゲストアカウントの一覧を作成
    2. スプレッドシートを承認者に共有し、アカウントのステータスを入力してもらう
    3. 入力結果を確認し、状態に応じてアカウントを更新（利用中、停止、承認者の変更、等）

**現状の課題:**
- アカウント発行に管理者を介する必要があり、即時発行できない
- 年に一度しか更新できず、承認者が自分のアカウントを確認できない
- ユーザー・管理者共に手間がかかる

**システムで解決:**
- 管理者を介さずに発行・更新が可能
- いつでも自分が承認しているアカウントを確認可能
- 管理者はアカウントの一覧やログを確認可能

---

# 主な機能

## 正職員向け機能

### ゲストアカウント発行
- **ページ:** `/issue`
- **機能:** ゲストアカウントを発行します
- **入力項目:**
  - 姓、名、所属、承認者、用途、利用期限（最大3ヶ月）
- **特徴:**
  - 複数アカウントを一度に発行可能
  - 「一人追加」ボタンで入力行を追加
  - 追加された行は前の行の値（所属・承認者・用途・期限）を自動継承

### 承認中アカウント一覧
- **ページ:** `/management`
- **機能:** 自分が承認しているゲストアカウントを一覧表示・管理します
- **表示項目:** メール、氏名、所属、用途、期限、ステータス
- **操作:**
  - **期限延長:** 利用期限を延長（最大+3ヶ月）
  - **情報修正:** 氏名、所属、用途を編集
  - **承認者変更:** 承認者を他の正職員に委譲
  - **延長承認:** ゲストからの延長申請を承認
  - **一時停止:** アカウントを一時的に停止
  - **アーカイブ:** アカウントをアーカイブ（6ヶ月後に自動除外）
  - **復旧:** 停止中・アーカイブ済みのアカウントを復旧

## ゲストユーザー向け機能

### 利用期限延長申請
- **ページ:** `/extension`
- **機能:** 自分のアカウントの利用期限延長を申請します
- **表示:** 現在のアカウント情報（利用期限、ステータス、既存の延長申請日）
- **操作:** 希望日を入力して申請（最大+3ヶ月）
  - 申請後、承認者の「承認中アカウント一覧」で「延長承認」ボタンが表示されます

## 管理者向け機能

### 全アカウント一覧
- **ページ:** `/admin/accounts`
- **機能:** システムに登録されているすべてのゲストアカウントを表示・管理
- **操作:** 正職員の「承認中アカウント一覧」と同様の操作が可能

### 管理ユーザー管理
- **ページ:** `/admin/user-master`
- **機能:** システムにログインできるユーザーを管理
- **操作:**
  - ユーザーの追加・編集・削除
  - 所属、雇用形態でフィルター
  - 各列でソート

### ログ閲覧
- **ページ:** `/admin/logs`
- **機能:** システムの操作履歴を閲覧
- **表示内容:**
  - 管理ユーザー変更履歴（ユーザーの作成・更新・削除）
  - ゲストアカウント変更履歴（発行、延長、承認者変更など）

### システム設定
- **ページ:** `/admin/settings`
- **機能:** システム管理者用設定ページ

### 通常ユーザービューへの切り替え
- 管理者は「通常ユーザービューに切り替え」ボタンで、正職員としての機能も利用可能

---

# 技術情報

## 技術スタック
- **フレームワーク:** Next.js 16.1.1 (App Router)
- **言語:** TypeScript (Strict mode)
- **スタイリング:** Tailwind CSS 4
- **データベース:** Cloud Firestore
- **外部連携:** Google Sheets API, Admin SDK (Directory API)
- **認証:** Identity-Aware Proxy (IAP) + アプリ独自の認可ロジック
- **デプロイ:** Cloud Run (Docker)

## セキュリティと認証
- **IAP検証:** バックエンド側でIAPトークンを検証し、不正アクセスを防止
- **認可フロー:**
  1. IAPによるドメイン/グループ制限（インフラ層）
  2. アプリ層でFirestoreの `user_master` コレクションを参照
     - `user_master` に存在しないユーザーはログイン不可

## データ保存
- **Firestore:** ゲストアカウント情報、ユーザーマスタ、ログを保存
- **Google Sheets:** ゲストアカウント関連の操作ログを記録（参照用）

## アカウントステータス
- **利用中:** 正常に利用可能なアカウント
- **停止中:** 一時的に停止されたアカウント
- **申請中:** 発行申請中または作成エラーが発生したアカウント
- **延長申請中:** ゲストから延長申請が提出されたアカウント
- **アーカイブ:** アーカイブされたアカウント（6ヶ月後に自動除外）
- **削除:** 削除されたアカウント

---

# 開発環境

## 環境変数
- `IAP_JWT_AUDIENCE`: IAP JWT検証用のオーディエンス
- `NEXT_PUBLIC_MOCK_USER_EMAIL`: 開発環境でのモックユーザーメールアドレス
- `NODE_ENV`: 環境モード（development/production）

## ローカル開発
- 開発モードではIAP検証をバイパスし、モックユーザーを使用可能
- Firestore接続は本番と同じ設定を使用
